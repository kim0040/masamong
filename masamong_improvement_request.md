# 프로젝트: Discord AI 봇 '마사몽' 고도화 및 안정화 요청서

## 1. 최종 목표 (The Goal)

제공된 '마사몽' Discord 봇의 전체 코드를 분석하고 리팩토링하여, 아래의 모든 조건을 만족하는 **안정적이고, 효율적이며, 지능적인 AI 에이전트**로 완성해 주십시오. 이 프로젝트의 최우선 순위는 **개인 사용자가 자신의 API 키를 사용하더라도 추가 과금이 발생하지 않도록 설계**하는 것입니다. 최종 결과물은 저사양 우분투(Ubuntu) 서버 환경에서 24/7 중단 없이 완벽하게 구동되어야 합니다.

## 2. 단계별 기술 요구사항 (Phased Technical Requirements)

첨부된 `agent.md`의 4단계 진화 전략에 따라 아래 요구사항을 순서대로 반영하여 코드를 수정해 주십시오.

### Phase 1: 생존 (Stability) - 안정성 확보

- **요구사항 1-1: 전역 예외 처리 방화벽 구축**
    
    - **지시:** `utils/api_handlers/` 내의 모든 API 호출 함수를 `try...except` 블록으로 감싸주십시오. `requests.exceptions.RequestException`, `google.api_core.exceptions` 등 각 API 라이브러리에서 발생할 수 있는 모든 잠재적 예외(연결 오류, 타임아웃, 데이터 파싱 오류 등)를 처리해야 합니다.
        
    - **결과:** 예외 발생 시, 치명적인 오류로 프로그램이 중단되는 대신, 오류를 `logger`에 기록하고 해당 함수는 `None`, `[]`, 또는 `{ "error": "메시지" }`와 같은 안전한 값을 반환하도록 수정하십시오.
        
- **요구사항 1-2: 명령어와 AI 대화의 역할 분리**
    
    - **지시:** `cogs/events.py`의 `on_message` 이벤트 리스너 로직을 수정하여, 메시지가 `config.py`에 정의된 접두사(`!`)로 시작할 경우, AI 대화 처리 로직(`_handle_ai_interaction`)이 실행되지 않고 즉시 `self.bot.process_commands(message)`로 처리되도록 하십시오.
        
    - **결과:** `!랭킹`, `!투표` 등의 명령어가 AI의 대화 기록에 남거나 AI가 불필요하게 반응하는 문제를 원천적으로 차단해야 합니다.
        

### Phase 2: 성장 (Efficiency) - 효율성 및 비용 최적화

- **요구사항 2-1: LLM 입력 데이터 전처리**
    
    - **지시:** `utils/data_formatters.py`를 활용하거나 신규 생성하여, 각 API 핸들러가 반환하는 원본 JSON 데이터를 LLM 친화적인 요약 텍스트(String)로 변환하는 포맷터를 구현하십시오. `agent.md`의 'Phase 2' 표에 명시된 것처럼, 불필요한 데이터를 제거하고 핵심 정보만 사람이 읽을 수 있는 문장으로 가공해야 합니다.
        
    - **결과:** `cogs/tools_cog.py`의 모든 도구 함수들은 원본 `dict` 대신 이 포맷터를 거친 최종 `str`을 반환하도록 수정하십시오.
        
- **요구사항 2-2: 2-Step LLM 아키텍처 구현 및 API 호출 제한 적용**
    
    - **지시:** `cogs/ai_handler.py`의 `process_agent_message` 함수를 리팩토링하여 `agent.md`에 명시된 2-Step 아키텍처를 구현하십시오.
        
        1. **1단계 (Lite Model):** 사용자 쿼리는 먼저 `gemini-2.5-flash-lite` 모델로 전달됩니다.
            
        2. **분기 처리:**
            
            - 도구가 필요 없는 단순 대화는 `lite` 모델이 직접 답변을 생성하고 프로세스를 **즉시 종료**해야 합니다.
                
            - 도구가 필요한 경우에만 `lite` 모델이 `<tool_call>`을 생성합니다.
                
        3. **2단계 (Main Model):** 도구 실행 후 얻은 **포맷팅된 결과 문자열**을 `gemini-2.5-flash` 모델에 전달하여 최종 답변을 생성합니다.
            
    - **결과:** `gemini-2.5-flash` 모델의 호출을 최소화하여 무료 할당량을 보존해야 합니다. 또한, `utils/db.py`의 `check_api_rate_limit` 함수를 활용하여 `config.py`에 정의된 RPM/RPD 제한에 따라 모든 Gemini API 호출 이전에 호출 가능 여부를 확인하는 로직을 반드시 포함해야 합니다.
        

### Phase 3: 지능 (Intelligence) - 기능 심화

- **요구사항 3-1: API 활용도 극대화**
    
    - **지시:** `utils/data_formatters.py`를 확장하여 `agent.md` 'Phase 3' 표에 명시된 추가 정보(습도, 풍속, 메타크리틱 점수, 플레이타임 등)를 포함한 풍부한 요약문을 생성하도록 개선하십시오.
        
- **요구사항 3-2: 능동적 비서 기능 구현**
    
    - **지시:** `cogs/proactive_assistant.py`를 중심으로, 사용자의 대화에서 '여행', '주식' 등의 키워드를 감지하여 관련 기능을 먼저 제안하는 로직을 구현하십시오. 예를 들어, "다음 달에 도쿄 가는데"라는 메시지에 봇이 먼저 "도쿄 날씨나 가볼 만한 곳을 찾아볼까?"라고 제안해야 합니다.
        

### Phase 4: 생태계 (Ecosystem) - 확장성 및 유지보수

- **요구사항 4-1: 구조적 로깅 강화**
    
    - **지시:** `logger_config.py`를 검토하여 모든 로그가 단순 텍스트가 아닌, `guild_id`, `user_id`, `trace_id` 등 분석에 용이한 메타데이터를 포함하는 **JSON 형식**으로 기록되도록 보장해주십시오.
        
- **요구사항 4-2: README.md 문서 종합 업데이트**
    
    - **지시:** `README.md` 파일을 아래 구조에 맞춰 완전히 새로 작성해주십시오.
        
        1. **프로젝트 설명:** 봇의 핵심 기능과 `agent.md`에 기반한 지능형 아키텍처를 설명합니다.
            
        2. **파일 구조도:** 프로젝트의 주요 디렉토리와 파일의 역할을 설명하는 트리 구조 다이어그램을 포함합니다.
            
        3. **상세한 설치 및 실행 방법 (우분투 기준):**
            
            - Python 3.9+ 및 `pip`, `venv` 설치 명령어.
                
            - `git clone`으로 프로젝트 복제.
                
            - 가상환경(`venv`) 생성 및 활성화 방법.
                
            - `pip install -r requirements.txt`로 의존성 설치.
                
            - `.env.example`을 `.env`로 복사하고, 각 API 키를 어디서 발급받아야 하는지 설명.
                
            - `python database/init_db.py`로 데이터베이스 초기화.
                
            - `python main.py`로 봇 실행.
                

## 3. 핵심 제약 조건 (Critical Constraints)

- **비용 문제:** 모든 API 연동은 무료 사용량(Free Tier) 내에서만 작동해야 합니다. `config.py`에 명시된 호출 제한(RPM/RPD)을 코드 레벨에서 엄격하게 준수하여 과금을 원천 차단해야 합니다.
    
- **실행 환경:** 모든 코드는 **저사양 우분투(Ubuntu) 서버**에서 최소한의 자원으로 안정적으로 실행될 수 있도록 최적화되어야 합니다.
    
- **저작권 및 라이선스:** 코드, 의존성 라이브러리 등 모든 요소는 저작권 문제가 없어야 합니다.
    

## 4. 최종 결과물 (Final Deliverables)

1. **수정된 전체 소스 코드:** 위의 모든 요구사항이 반영된 Python 코드 파일들.
    
2. **업데이트된 `README.md` 파일:** 요구사항 4-2에 맞춰 새로 작성된 상세한 문서.
    

이 요청서에 따라 프로젝트를 성공적으로 완수해 주십시오.


---

# AI 에이전트 작업 지시서: 마사몽 2.0 안정화 및 고도화

## 1. 프로젝트 최종 목표 (GOAL)

현재 Python `discord.py`로 구현된 '마사몽' 챗봇의 불안정한 기능을 안정화하고, 장기 기억 능력을 고도화하여 **저사양 우분투 서버 환경에서 안정적으로 운영 가능한**, 지속 가능하고 확장 가능한 지능형 대화 플랫폼으로 업그레이드한다.

## 2. 현재 코드베이스 상태 (CONTEXT)

* **작동하는 부분:** 기본적인 AI 상호작용은 정상적으로 처리되고 있음.
* **시급한 문제점:**
    1.  **날씨 API 완전 불능:** 기상청 API의 주소 및 요청 방식 변경으로 인해 `!날씨` 명령어 및 관련 기능이 전혀 작동하지 않음.
    2.  **로그 가독성 저하:** 모든 로그가 채널 구분 없이 한곳에 기록되어, 특정 채널의 대화 흐름이나 문제 상황을 추적하기 매우 어려움.
    3.  **메모리 시스템의 잠재적 위험:** 현재 대화 기록을 `collections.deque`에 저장하는 방식은, 대화가 길어질수록 AI 모델에 전달되는 토큰 수가 무한정 늘어나 결국 API 한계치를 초과하게 됨. 이는 어느 순간 봇이 응답 불능 상태에 빠질 수 있는 **매우 심각한 설계 결함**임.
    4.  **AI의 발언 오인:** AI가 대화 기록 형식(`User(ID|이름): 내용`)을 잘못 해석하여, 사용자의 닉네임을 실제 발언 내용의 일부로 착각하고 응답하는 문제가 발생함.
    5.  **데이터 유실 위험:** 사용자 활동 기록(`activity_data.json`), API 호출 횟수 등 중요 데이터가 파일 또는 인메모리에 저장되어, 봇 재시작 시 데이터가 유실될 위험이 있음.

## 3. 핵심 아키텍처 및 기술 원칙 (PRINCIPLES)

업그레이드 전 과정에서 다음 기술과 원칙을 반드시 준수해야 한다.

* **저사양 서버 최적화:** 모든 기술 선택과 구현은 메모리(RAM)와 CPU 사용량을 최소화하는 것을 최우선으로 고려한다. 별도의 데이터베이스 서버나 무거운 라이브러리 설치를 지양한다.
* **데이터베이스 중심 설계:** 모든 상태 정보(대화, 설정, 사용자 활동, API 카운터 등)는 **`SQLite`**에 영속적으로 저장하여 데이터의 일관성과 안정성을 확보한다.
* **날씨 API:**
    * 기존의 모든 기상청 API 호출 로직을 폐기한다.
    * 새로운 **기상청 API 허브([https://apihub.kma.go.kr/](https://apihub.kma.go.kr/))**의 **'단기예보 조회(VilageFcstInfoService\_2.0)'** 서비스를 사용하도록 전면 교체한다.
* **로깅 시스템:**
    * 모든 로그 메시지, 특히 채팅과 관련된 로그는 **`[서버명/채널명]`** 또는 **`[서버ID/채널ID]`** 와 같은 명확한 접두사를 포함하여, 어떤 채널에서 발생한 이벤트인지 즉시 식별할 수 있어야 한다.
* **AI 메모리 및 프롬프트 아키텍처 (가장 중요):**
    * **`deque` 메모리 방식 폐기:** 토큰 문제를 유발하는 현재의 인메모리 `deque` 방식을 완전히 제거한다.
    * **사용자 발언의 명확한 구분:** AI에게 전달되는 대화 기록에서 `User(ID|이름):` 부분은 발언의 주체를 나타내는 **메타데이터**이며, 사용자의 실제 발언이 아님을 명확히 인지해야 한다. 콜론(`:`) 뒤의 내용만이 실제 발언이므로, 사용자의 닉네임을 그들이 직접 말한 것처럼 언급하는 오류를 범해서는 안 된다.
    * **검색 증강 생성 (RAG) 도입:**
        1.  **영속적 저장 및 분리:** 모든 대화 기록을 `user_id`, `channel_id`와 함께 `SQLite` 데이터베이스에 영구적으로 저장한다.
        2.  **벡터 임베딩:** `sentence-transformers` 라이브러리를 사용하여 저장된 대화 내용을 벡터(Vector) 형태로 변환한다.
        3.  **개인화된 유사도 검색:** 사용자의 새로운 질문이 들어오면, 질문을 벡터로 변환한 뒤 데이터베이스에서 **'현재 대화 중인 사용자가, 현재 채널에서 했던 말'** 중에서 의미적으로 가장 관련성 높은 내용 몇 개만 검색하여 가져온다.
        4.  **선별적 컨텍스트 제공:** 검색된 **핵심 관련 정보**만을 AI 프롬프트에 포함하여 API를 호출한다. 이를 통해 토큰 사용량을 획기적으로 줄이고, 상시 메모리 점유율을 낮게 유지할 수 있어 저사양 환경에 필수적이다.

## 4. 단계별 실행 계획 (EXECUTION PLAN)

아래 순서에 따라 업그레이드를 진행한다.

### **1단계: 핵심 기능 안정화 및 규칙 강화**

1.  **날씨 API 로직 전면 재구축 (`utils.py`, `weather_cog.py`):**
    * 새로운 API 규격에 맞춰 URL, 요청 파라미터, 응답 파싱 로직을 전면 수정한다.
    * API 호출 실패, 데이터 없음 등 다양한 예외 상황에 대한 처리를 강화한다.
2.  **로깅 시스템 가독성 향상 (`logger_config.py` 및 전체 Cog 파일):**
    * 모든 로그 메시지에 `[서버명/채널명]` 접두사가 포함되도록 수정한다.
3.  **AI 페르소나 규칙 강화 (`config.py`):**
    * `CHANNEL_AI_CONFIG`의 `"rules"` 항목에, **"메타데이터와 발언 구분: `User(ID|이름):` 부분은 메타데이터일 뿐, 사용자가 실제로 한 말이 아니다..."** 라는 규칙을 명시적으로 추가한다.
4.  **데이터 영속성 확보 (`activity_cog.py`, `ai_handler.py`):**
    * `activity_data.json` 파일 시스템을 제거하고, 모든 사용자 활동 기록(`!랭킹`)이 `SQLite`의 `user_activity` 테이블을 사용하도록 `activity_cog.py`를 리팩토링한다.
    * `ai_handler.py`와 `utils.py`의 인메모리 API 호출 카운터를 `SQLite`의 `system_counters` 테이블로 이전하여, 봇 재시작 시에도 카운트가 유지되도록 수정한다.

### **2단계: 지능형 장기 기억 시스템 구축 (RAG)**

1.  **의존성 추가:** `requirements.txt`에 `sentence-transformers`와 `torch` (CPU 버전)를 추가한다. 저사양 서버에 최적화된 경량 모델(`paraphrase-multilingual-MiniLM-L12-v2` 등)을 사용한다.
2.  **데이터베이스 스키마 확장 (`database/schema.sql`):**
    * `conversation_history` 테이블에 벡터 저장을 위한 `embedding BLOB` 컬럼을 추가한다.
3.  **대화 기록 및 벡터화 로직 구현 (`ai_handler.py`):**
    * `add_message_to_history` 함수를 수정하여, 메시지를 DB에 저장하고 백그라운드에서 벡터로 변환하여 업데이트하도록 변경한다.
4.  **검색 및 프롬프트 증강 로직 구현 (`ai_handler.py`):**
    * `_generate_gemini_response` 함수를 재설계하여, DB에서 현재 사용자와 채널에 맞는 과거 대화 기록을 벡터 검색으로 찾아내고, 이 내용만으로 AI 프롬프트를 구성하도록 변경한다.

## 5. 추가 개선 및 고도화 제안 (Advanced Enhancements)

위 2단계가 모두 완료된 후, 마사몽을 진정한 '플랫폼'으로 발전시키기 위한 다음 기능들을 추가할 것을 제안한다.

* **동적 설정 관리 시스템:**
    * 관리자 전용 `settings_cog.py`를 신설한다.
    * 서버 관리자가 디스코드 내에서 슬래시 커맨드(`/config set`, `/persona change`)를 사용하여, 봇을 재시작하지 않고도 실시간으로 AI 페르소나, 기능 활성화 여부, 채널별 권한 등을 변경할 수 있도록 한다.
    * 이를 위해 `config.py`의 정적 설정들을 `guild_settings` 데이터베이스 테이블로 이전한다.
* **운영 분석 대시보드:**
    * `analytics_log` 테이블을 데이터베이스에 추가한다.
    * 명령어 사용 빈도, AI 토큰 사용량, API 호출 지연 시간 등 운영에 필요한 모든 지표를 구조화된 로그로 기록한다.
    * 이를 통해 "어떤 기능이 가장 인기 있는가?", "AI 운영 비용이 얼마나 발생하는가?" 와 같은 질문에 데이터 기반으로 답변하고, 봇의 성능과 비용을 최적화한다.
* **백그라운드 작업 안정성 강화:**
    * `weather_cog.py` 등에서 사용하는 모든 `tasks.loop`에 `@tasks.loop.error` 데코레이터를 추가한다.
    * 이를 통해 백그라운드 작업(날씨 알림 등) 실행 중 예외가 발생하더라도, 오류를 상세히 로깅하고 루프가 완전히 멈추는 '조용한 죽음'을 방지하여 안정성을 대폭 향상시킨다.

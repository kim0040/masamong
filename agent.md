
---

# AI 에이전트 작업 지시서: 마사몽 2.0 리팩토링 및 고도화

## 1. 프로젝트 최종 목표 (GOAL)

현재 Python `discord.py`로 구현된 '마사몽' 챗봇을, 저사양 우분투 서버 환경에서 운영 가능한 **고성능 지능형 대화 플랫폼**으로 전면 리팩토링한다. 최종 목표는 다음과 같은 핵심 기능을 갖춘 '마사몽 2.0'을 완성하는 것이다.

1.  **영속적 기억:** 모든 상태(대화 기록, 사용자 활동, 서버 설정)가 재시작 후에도 완벽하게 보존되어야 한다.
2.  **지능적 지식 활용:** 과거 대화를 '기억'하고 검색하여, 사실에 기반한 깊이 있는 답변을 생성해야 한다.
3.  **유연한 의사결정:** 사용자의 자연어 명령을 깊이 이해하고, 봇의 기능을 스스로 판단하여 실행해야 한다.

## 2. 현재 코드베이스 상태 (CONTEXT)

* **언어/프레임워크:** Python 3.11, `discord.py`
* **AI 모델:** `Gemini 2.5 Flash` (2025년 8월 16일 기준 최적 모델)
* **상태 관리 방식 (문제점):**
    * 대화 기록: `collections.deque` (인메모리, 휘발성)
    * 사용자 활동: `dict` + `activity_data.json` (파일 I/O, 동시성 문제 발생 가능)
    * API 호출 횟수: 전역 변수 (휘발성)
* **의도 분석 방식 (문제점):**
    * `ai_handler.py`에서 별도의 AI 모델을 호출하여 'Chat', 'Weather' 등 단순 카테고리로 분류.
    * `events.py`에서 "운세", "요약" 등 특정 키워드를 감지하는 `if/elif` 분기문 사용.
    * 이 방식은 유연성이 떨어지고, 새로운 기능을 추가할 때마다 코드가 복잡해짐.
* **현재 작동 오류 (시급한 문제):**
    * **AI 응답 불능:** 유효하지 않은 API 키 또는 내부 로직 문제로 인해 멘션에 응답하지 않음.
    * **API 연동 실패:** 기상청 API의 주소 및 요청 방식 변경으로 인해 날씨 기능이 완전히 작동하지 않음.
    * **백그라운드 작업 오류:** 일부 설정값 누락으로 인해 주기적인 알림 기능이 시작과 동시에 실패함.

## 3. 핵심 아키텍처 및 기술 원칙 (PRINCIPLES)

리팩토링 전 과정에서 다음 기술과 원칙을 반드시 준수해야 한다.

* **데이터베이스:**
    * **`SQLite`**를 유일한 데이터 저장소로 사용한다.
    * 비동기 처리를 위해 **`aiosqlite`** 라이브러리를 사용한다.
    * 별도의 DB 서버를 설치하지 않고, `database/remasamong.db` 단일 파일로 모든 데이터를 관리하여 저사양 서버의 리소스 사용을 최소화한다.
* **AI 아키텍처:**
    * **검색 증강 생성 (RAG):**
        * 모든 대화 기록을 `SQLite`에 저장한다.
        * `sentence-transformers` 라이브러리를 사용하여 대화 내용을 벡터로 임베딩한다.
        * 사용자 질문이 들어오면, `SQLite`에 저장된 과거 대화 벡터 중 가장 관련성 높은 내용을 검색하여 AI 프롬프트에 포함시킨다.
    * **함수 호출 (Function Calling):**
        * 기존의 모든 명령어(`!날씨`, `!운세` 등)를 AI가 이해할 수 있는 Python '도구(Tool)' 함수로 재정의한다.
        * `events.py`의 복잡한 의도 분석 로직을 제거하고, `Gemini 2.5 Flash`의 함수 호출 기능을 사용하여 AI가 직접 적절한 도구를 선택하고 실행하도록 한다.
* **코드 구조:**
    * 기존의 `discord.py` Cog 모듈 구조를 유지하고 강화한다.
    * 각 Cog는 `main.py`로부터 데이터베이스 연결 객체를 주입받아 사용한다.

## 4. 단계별 실행 계획 (EXECUTION PLAN)

아래 순서에 따라 리팩토링을 진행한다. 각 단계는 이전 단계의 성공 위에 구축된다.

### **0단계: 현재 코드베이스 안정화 및 개선 (선행 작업)**

본격적인 리팩토링에 앞서, 현재 코드가 오류 없이 원활하게 작동하도록 모든 문제를 해결한다.

1.  **API 키 검증 및 갱신:** `.env` 파일의 `GEMINI_API_KEY`와 `KMA_API_KEY`가 유효한지 확인하고, 만료되었다면 즉시 갱신한다.
2.  **기상청 API 로직 전면 수정:** `utils.py`와 `config.py`를 수정하여, 변경된 기상청 API v2의 URL, 요청 파라미터(nx, ny 좌표), JSON 응답 처리 방식에 완벽하게 대응하도록 한다.
3.  **AI 응답 로직 복원:** `events.py`의 `_handle_ai_interaction` 함수를 정밀 디버깅하여, 멘션에 대한 AI 응답이 누락되는 '조용한 오류'를 해결한다.
4.  **설정값 오류 수정:** `weather_cog.py` 등에서 발생하는 `AttributeError`를 해결하기 위해, 변경된 `config.py`의 설정값(`DEFAULT_NX`, `DEFAULT_NY` 등)을 올바르게 참조하도록 코드를 수정한다.
5.  **의존성 정리:** `requirements.txt`를 최신화하고, 모든 라이브러리가 서로 충돌 없이 안정적으로 설치되는지 확인한다.

### **1단계: 데이터베이스 기반 구축 (영속성 확보)**

1.  **의존성 추가:** `requirements.txt`에 `aiosqlite`를 추가한다.
2.  **DB 초기화:** `database/schema.sql`에 모든 테이블(user_activity, conversation_history 등) 생성 구문을 정의하고, 이를 실행하는 `database/init_db.py` 스크립트를 작성한다.
3.  **`main.py` 수정:** 봇 시작 시 `aiosqlite` 데이터베이스에 연결하고, 이 연결 객체를 봇 인스턴스에 저장하는 로직을 `setup_hook`에 구현한다.
4.  **`activity_cog.py` 리팩토링:** `activity_data.json` 파일 읽기/쓰기 로직을 제거한다. 모든 사용자 활동 기록 및 `!랭킹` 명령어 처리가 `SQLite`의 `user_activity` 테이블을 사용하도록 수정한다. (SQL은 `INSERT ... ON CONFLICT UPDATE` 구문을 사용하여 동시성 문제를 원천 차단)
5.  **`ai_handler.py` 수정:** `collections.deque`를 제거한다. 새로운 대화(사용자, 봇)가 발생할 때마다 `SQLite`의 `conversation_history` 테이블에 기록하도록 수정한다. (이 단계에서는 아직 RAG를 구현하지 않음)

### **2단계: RAG 코어 구현 (장기 기억 부여)**

1.  **의존성 추가:** `requirements.txt`에 `sentence-transformers`를 추가한다.
2.  **`ai_handler.py` 리팩토링:**
    * 사용자 질문이 들어왔을 때, `sentence-transformers`를 사용하여 질문을 벡터로 변환하는 기능을 추가한다.
    * 변환된 벡터를 사용하여, `conversation_history` 테이블에서 의미적으로 가장 유사한 과거 대화 내용을 검색하는 기능을 구현한다. (이때, `SQLite`의 벡터 검색 확장 기능을 활용하는 코드를 작성해야 함)
    * AI에게 프롬프트를 보낼 때, 검색된 과거 대화 내용을 함께 포함하여 "이 내용을 참고해서 답변해"라는 형식의 증강된 프롬프트를 생성하도록 기존 로직을 완전히 교체한다.
    * 새로운 대화가 `conversation_history`에 저장될 때, 해당 대화 내용도 벡터로 변환하여 벡터 인덱스에 추가하는 비동기 백그라운드 작업을 구현한다.

### **3단계: 함수 호출 라우터 전환 (지능형 의사결정)**

1.  **'도구' 함수 정의:** `weather_cog.py`, `fun_cog.py`, `poll_cog.py`의 기존 명령어 로직을, 명확한 `docstring`과 타입 힌트를 가진 독립적인 Python 함수로 재정의한다.
2.  **`events.py` 리팩토링:**
    * `on_message`에서 `_handle_ai_interaction`을 호출하는 로직을 수정한다.
    * `_handle_ai_interaction` 내부의 복잡한 `if/elif` 의도 분석 로직을 모두 제거한다.
    * 대신, **(2단계에서 구현한) RAG 컨텍스트**와 **(방금 정의한) 사용 가능한 도구 목록**을 함께 `Gemini 2.5 Flash` 모델에 전달하는 단일 API 호출 로직으로 변경한다.
    * AI의 응답을 분석하여, 일반 텍스트 응답이면 그대로 출력하고, 함수 호출(Function Call) 응답이면 해당 함수를 실행한 뒤 그 결과를 바탕으로 최종 답변을 생성하도록 구현한다.

## 5. 추가 개선 및 고도화 제안 (Advanced Enhancements)

위 3단계가 모두 완료된 후, 마사몽을 진정한 '플랫폼'으로 발전시키기 위한 다음 기능들을 추가할 것을 제안한다.

* **동적 설정 관리 시스템:**
    * 관리자 전용 `settings_cog.py`를 신설한다.
    * 서버 관리자가 디스코드 내에서 슬래시 커맨드(`/config set`, `/persona change`)를 사용하여, 봇을 재시작하지 않고도 실시간으로 AI 페르소나, 기능 활성화 여부, 채널별 권한 등을 변경할 수 있도록 한다.
    * 이를 위해 `config.py`의 정적 설정들을 `guild_settings` 데이터베이스 테이블로 이전한다.
* **운영 분석 대시보드:**
    * `analytics_log` 테이블을 데이터베이스에 추가한다.
    * 명령어 사용 빈도, AI 토큰 사용량, API 호출 지연 시간 등 운영에 필요한 모든 지표를 구조화된 로그로 기록한다.
    * 이를 통해 "어떤 기능이 가장 인기 있는가?", "AI 운영 비용이 얼마나 발생하는가?" 와 같은 질문에 데이터 기반으로 답변하고, 봇의 성능과 비용을 최적화한다.
* **멀티모달(Multi-modal) 기능 확장:**
    * Gemini 모델의 이미지 인식 능력을 활용하여, 사용자가 업로드한 이미지를 봇이 '보고' 설명하거나 관련된 질문에 답변하는 기능을 추가한다.

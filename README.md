# 마사몽 AI 챗봇 2.0: 지능형 대화 플랫폼

마사몽은 단순한 명령어 봇을 넘어, 서버의 모든 대화를 기억하고, 문맥을 깊이 있게 이해하며, 사용자의 자연어 명령을 지능적으로 수행하는 AI 대화 플랫폼입니다. '마사몽'이라는 독특한 페르소나를 바탕으로 서버 멤버들과 진정한 유대감을 형성하고, 커뮤니티에 활기를 불어넣는 것을 목표로 합니다.

## 🤖 봇의 핵심 기능

마사몽 2.0은 저사양 서버 환경에서도 최상의 성능을 발휘할 수 있도록 설계된, 다음과 같은 최신 AI 아키텍처를 기반으로 동작합니다.

- **서버별 영속적 대화 기억 (RAG)**
  봇은 더 이상 대화 내용을 잊어버리지 않습니다. 모든 상호작용은 `SQLite` 데이터베이스에 영구적으로 저장되며, **각 서버(길드)별로 완벽하게 분리되어 기억됩니다.** A서버의 대화 내용이 B서버의 대화에 영향을 주지 않습니다. **검색 증강 생성(RAG)** 기술을 통해, 봇은 해당 서버의 대화 기록 속에서만 현재 대화와 가장 관련 높은 '기억'을 실시간으로 찾아내어 답변을 생성합니다.

- **지능형 기능 라우팅 (Function Calling)**
  딱딱한 명령어는 이제 필수가 아닙니다. 봇의 모든 기능(`날씨`, `요약`, `투표` 등)은 AI가 이해할 수 있는 하나의 '도구(Tool)'로 정의되어 있습니다. 사용자가 자연어로 무언가를 요청하면, Gemini AI가 그 의도를 파악하여 가장 적절한 도구를 스스로 선택하고 실행하여 그 결과를 바탕으로 답변합니다.

- **서버별 동적 페르소나**
  서버 관리자는 슬래시 커맨드(`/persona set`)를 통해 자신의 서버에만 적용되는 AI의 역할, 말투, 정체성을 직접 설정할 수 있습니다. 설정된 페르소나는 데이터베이스에 저장되어 봇의 모든 응답에 반영됩니다.

- **채널 내 활동 로깅**
  서버에 `logs` 라는 이름의 텍스트 채널을 만들어두면, 해당 서버의 모든 채팅이 보기 좋은 임베드(Embed) 형태로 해당 채널에 자동으로 기록됩니다. 이를 통해 서버 활동을 쉽게 모니터링할 수 있습니다.

## ✨ 사용 방법 상세 안내

마사몽과 상호작용하는 방법은 크게 세 가지입니다: **AI 채팅**, **레거시 명령어**, 그리고 **서버 관리용 슬래시 커맨드**.

### 1. 지능형 AI 채팅 (자연어 상호작용)

가장 핵심적인 사용법입니다. `@마사몽`으로 봇을 멘션하여 대화를 시작하세요.

#### 일반 대화
봇의 페르소나를 즐기며 자유롭게 대화할 수 있습니다.
- `@마사몽 안녕, 오늘 기분 어때?`
- `@마사몽 심심한데 재밌는 얘기 해줘.`

#### 정보 검색 (RAG 활용)
봇은 서버 내에서 오고 간 과거 대화를 모두 기억하고 있습니다.
- `@마사몽 우리가 지난주에 논의했던 데이터베이스 최적화 방안 다시 알려줄래?`
- `@마사몽 아까 hyeongus님이 공유했던 링크가 뭐였지?`

#### 기능 실행 (Function Calling 활용)
명령어를 쓰는 대신, 사람에게 말하듯 자연스럽게 요청하면 AI가 의도를 파악하여 적절한 기능을 실행합니다.
- **날씨 조회:** `@마사몽 내일 서울 날씨 어때?`
- **운세 보기:** `@마사몽 오늘 내 운세 좀 봐줘.`
- **대화 요약:** `@마사몽 방금 무슨 얘기했는지 3줄로 요약해줄래?`
- **투표 생성:** `@마사몽 "오늘 저녁 뭐 먹지?" 이걸로 "치킨", "피자", "굶기" 투표 열어줘.`

#### 자발적 대화 참여
대화 중에 `마사몽`, `봇`, `AI` 등의 키워드가 포함되면, 봇이 스스로 판단하여 대화에 끼어들 수 있습니다. 이 기능은 `config.py`에서 켜고 끌 수 있습니다.

### 2. 레거시 명령어
`!` 접두사를 사용하는 전통적인 방식의 명령어입니다. AI의 판단 없이 즉각적인 실행을 원할 때 유용합니다.

- `!랭킹` 또는 `!수다왕`
  - **설명:** 현재 서버에서 메시지를 가장 많이 작성한 유저들의 순위를 보여줍니다.
  - **사용법:** `!랭킹`

- `!투표 "질문" "항목1" "항목2" ...`
  - **설명:** 간단한 찬반 투표나 객관식 투표를 생성합니다. 질문과 각 선택 항목은 반드시 큰따옴표(`"`)로 감싸야 합니다. 선택 항목은 최대 10개까지 가능합니다.
  - **사용법:** `!투표 "저녁 메뉴" "치킨" "피자"`

- `!운세`
  - **설명:** 오늘의 운세를 AI가 생성하여 알려줍니다.
  - **사용법:** `!운세`

- `!요약`
  - **설명:** 현재 채널의 최근 대화 내용을 AI가 요약해줍니다.
  - **사용법:** `!요약`

### 3. 서버 관리 (슬래시 커맨드)
서버 관리자만 사용할 수 있는 기능으로, `/`를 입력하여 사용합니다.

- `/persona set`
  - **설명:** 이 서버에서만 사용될 AI의 페르소나를 새로 설정합니다. 매우 상세하게 작성할수록 AI가 역할을 더 잘 이해합니다.
  - **인자:** `new_persona` (문자열) - 새로운 페르소나 설명.
  - **사용법:** `/persona set`을 입력하고 `new_persona` 필드에 원하는 페르소나 설명을 입력합니다.

- `/persona view`
  - **설명:** 현재 서버에 설정된 커스텀 페르소나를 확인합니다. 설정된 내용이 없다면 기본 페르소나를 사용 중임을 알려줍니다.
  - **사용법:** `/persona view`

## 🛠️ 기술 스택

- **Core Framework:** `discord.py`
- **AI Engine:** Google Gemini API (`gemini-2.5-flash-lite`)
- **Embeddings for RAG:** Google Gemini Embedding API (`embedding-001`)
- **Database:** `SQLite`
- **Async DB Driver:** `aiosqlite`
- **Vector Search:** `sqlite-vss`

## ⚙️ 설치 및 실행

### 1. 요구 사항
- Python 3.11 이상
- Discord Bot Token
- Google Gemini API Key
- [기상청 공공데이터포털](https://www.data.go.kr/data/15057682/openapi.do) API 키

### 2. 설치 과정
```bash
# 1. 저장소 복제
git clone https://github.com/your-repo/masamong-2.0.git
cd masamong-2.0

# 2. 파이썬 가상환경 생성 및 활성화
# Windows: python -m venv venv && .\venv\Scripts\activate
# macOS/Linux: python3 -m venv venv && source venv/bin/activate
python3 -m venv venv
source venv/bin/activate

# 3. 필수 라이브러리 설치
# (torch 등 무거운 라이브러리가 필요 없어 설치가 매우 가볍고 빠릅니다.)
pip install -r requirements.txt

# 4. .env 파일 설정
# .env.example 파일이 있다면 복사하고, 없다면 새로 만들어 아래 내용을 채웁니다.
# cp .env.example .env
# nano .env 또는 다른 편집기로 아래 값을 입력
# DISCORD_BOT_TOKEN="YOUR_DISCORD_BOT_TOKEN"
# GEMINI_API_KEY="YOUR_GEMINI_API_KEY"
# KMA_API_KEY="YOUR_KMA_API_KEY"

# 5. 데이터베이스 초기화 (최초 1회만 실행)
# 이전에 DB를 생성했더라도, 스키마가 변경되었을 수 있으니 다시 실행하는 것을 권장합니다.
python database/init_db.py

# 6. 봇 실행
python main.py
```

## 📁 프로젝트 구조

- `main.py`: 🤖 봇의 생명주기를 관리하는 메인 실행 파일.
- `config.py`: 🧠 봇의 기본 페르소나, API 제한 등 핵심 설정을 담은 파일.
- `cogs/`: 🧩 각 기능별 모듈(Cog)이 들어있는 폴더.
    - `ai_handler.py`: Gemini API와의 모든 통신, RAG, 함수 호출을 전담하는 핵심 두뇌.
    - `events.py`: 👂 디스코드의 모든 이벤트를 감지하고 다른 Cog에 전달하는 귀.
    - `logging_cog.py`: 📜 서버별 `logs` 채널에 채팅 기록을 남기는 기능.
    - `weather_cog.py`: 🌦️ 날씨 조회 '도구'와 주기적 알림 기능.
    - `fun_cog.py`: 🎉 운세, 요약 '도구' 기능.
    - `poll_cog.py`: 🗳️ 투표 생성 '도구' 기능.
    - `activity_cog.py`: 📊 사용자 활동을 DB에 기록하고 랭킹을 제공하는 기능.
    - `settings_cog.py`: ⚙️ 서버 관리용 슬래시 커맨드 기능.
- `database/`: 💾 데이터베이스 관련 파일.
- `utils.py`: 🔧 여러 모듈에서 공통으로 사용하는 유틸리티 함수.
- `requirements.txt`: 📜 실행에 필요한 라이브러리 목록.

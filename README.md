
-----

# 마사몽 AI 챗봇 2.0: 지능형 대화 플랫폼

마사몽은 단순한 명령어 봇을 넘어, 서버의 모든 대화를 기억하고, 문맥을 깊이 있게 이해하며, 사용자의 자연어 명령을 지능적으로 수행하는 AI 대화 플랫폼입니다. '마사몽'이라는 독특한 페르소나를 바탕으로 서버 멤버들과 진정한 유대감을 형성하고, 커뮤니티에 활기를 불어넣는 것을 목표로 합니다.

## 🤖 봇의 핵심 컨셉

마사몽 2.0은 저사양 서버 환경에서도 최상의 성능을 발휘할 수 있도록 설계된, 다음과 같은 최신 AI 아키텍처를 기반으로 동작합니다.

  * **AI 기반 페르소나**
    '마사몽'은 단순한 정보 제공자가 아닌, 독특한 말투와 성격을 가진 서버의 일원입니다. 모든 답변은 이 페르소나를 기반으로 생성되어 사용자에게 일관되고 재미있는 경험을 제공합니다.

  * **영속적 대화 기억 (RAG)**
    봇은 더 이상 대화 내용을 잊어버리지 않습니다. 모든 상호작용은 `SQLite` 데이터베이스에 영구적으로 저장됩니다. **검색 증강 생성(RAG)** 기술을 통해, 봇은 이 방대한 대화 기록 속에서 현재 대화와 가장 관련 높은 '기억'을 실시간으로 찾아내어, 깊이 있고 사실에 기반한 답변을 생성합니다.

  * **지능형 기능 라우팅 (Function Calling)**
    딱딱한 명령어는 이제 필요 없습니다. 봇의 모든 기능(`날씨`, `운세`, `투표` 등)은 AI가 이해할 수 있는 하나의 '도구(Tool)'로 정의되어 있습니다. 사용자가 자연어로 무언가를 요청하면, Gemini AI가 그 의도를 파악하여 가장 적절한 도구를 스스로 선택하고 실행합니다.

  * **동적 & 자발적 대화 참여**
    봇은 `@멘션`으로 호출될 때만 응답하는 수동적인 존재가 아닙니다. 대화의 흐름을 지켜보다가 자신과 관련된 키워드가 나오면, '눈치 보는 AI'의 판단을 거쳐 자연스럽게 대화에 참여합니다. 이 기능은 서버별로 동적으로 켜고 끌 수 있습니다.

## ✨ 주요 기능 및 사용법

마사몽은 정보 제공, 엔터테인먼트, 커뮤니티 활성화 등 다양한 기능을 **자연어**로 사용하거나, 명확한 행동을 원할 때 **전통적인 명령어**로 사용할 수 있습니다.

### 1\. 지능형 AI 채팅 (자연어 상호작용)

`@마사몽`으로 봇을 직접 호출하여 질문하거나, 대화 중에 `마사몽`, `봇` 등의 키워드를 언급하여 봇의 참여를 유도할 수 있습니다.

  * **일반 대화:** `@마사몽 심심한데 재밌는 얘기 해줘`
  * **정보 검색:** `@마사몽 어제 우리가 얘기했던 LLM 최적화 방안 다시 설명해줄래?` (RAG를 통해 과거 대화 검색)
  * **기능 실행:**
      * `@마사몽 내일 서울 날씨 어때?`
      * `@마사몽 오늘 내 운세 좀 봐줘`
      * `@마사몽 방금 무슨 얘기했는지 3줄로 요약해줄래?`
      * `@마사몽 "오늘 점심 메뉴는?" 이걸로 "짜장면"이랑 "짬뽕" 투표 열어줘`

### 2\. 커뮤니티 기능 (전통 명령어)

명확한 실행을 원할 때는 기존의 명령어를 그대로 사용할 수 있습니다.

  * **활동 랭킹:** 서버 내 메시지 작성 빈도를 기준으로 '수다왕' 랭킹을 보여줍니다.
      * `!랭킹` 또는 `!수다왕`
  * **간단한 투표:** 간단한 주제에 대해 투표를 생성합니다.
      * `!투표 "질문" "항목1" "항목2" ...` (항목은 최대 10개)
      * **예시:** `!투표 "오늘 점심 메뉴는?" "짜장면" "짬뽕"`

### 3\. 관리 및 로깅

  * **구조화된 로그:** 모든 활동은 `discord_logs.txt`, `error_logs.txt` 파일에 체계적으로 기록되어 문제 추적이 용이합니다.
  * **로그 파일 관리:** 관리자는 `!로그삭제` 명령어를 통해 로그 파일을 수동으로 삭제할 수 있습니다.

## 🛠️ 아키텍처 및 기술 스택

마사몽은 저사양 우분투 서버 환경에서의 안정성과 효율성에 초점을 맞춰 설계되었습니다.

  * **Core Framework:** `discord.py`
  * **AI & NLP:** 이 프로젝트의 AI 핵심부는 **현재의 안정적인 기반**과 **미래의 지능형 플랫폼**이라는 두 가지 측면을 모두 고려하여 설계되었습니다.
      * **LLM Engine (현재와 미래):** `google-generativeai` 라이브러리를 통해 Google의 최신 언어 모델을 사용합니다. 2025년 8월 16일 현재, 저지연성과 높은 성능, 그리고 정교한 함수 호출 기능을 모두 고려했을 때 **Gemini 2.5 Flash** 모델이 저사양 서버 환경에서 가장 비용 효율적이고 적합한 선택입니다.
      * **현재의 AI 로직:** 현재 봇은 `Gemini 2.5 Flash`를 사용하여 사용자의 멘션에 응답하고, 대화의 의도('날씨 질문', '일반 대화' 등)를 분석하는 안정적인 기반을 갖추고 있습니다.
      * **미래의 AI 아키텍처 (구현 목표):**
          * **`sentence-transformers` (RAG 임베딩):** 단순히 최근 대화 몇 개만 기억하는 단기 기억의 한계를 넘어, 서버의 모든 대화 기록을 벡터로 변환하여 '장기 기억'을 구축합니다. 이를 통해 봇은 과거의 대화 내용을 검색하고 참조하여 답변하는 **검색 증강 생성(RAG)** 능력을 갖추게 됩니다.
          * **`konlpy` (한국어 형태소 분석):** AI의 한국어 이해도를 극대화하기 위한 보조 엔진입니다. 대화 내용을 벡터로 변환하기 전에 형태소 분석을 통해 핵심 의미 단위(명사, 동사 등)를 추출하여, RAG의 검색 정확도를 한 단계 더 끌어올립니다.
  * **데이터베이스 (영속성 계층):** `SQLite` + `aiosqlite`. 별도의 서버 프로세스 없이, 단일 파일로 모든 데이터를 관리하여 저사양 환경의 리소스 소모를 최소화합니다.
  * **배포 환경:** `Python 3.11`, `Ubuntu Server`, `systemd` (서비스 관리)

## 📁 프로젝트 파일 구조

이 프로젝트는 각 파일이 명확한 책임을 갖도록 모듈식으로 설계되었습니다. 봇이 시작되고 메시지에 응답하는 흐름을 따라 각 파일의 역할을 이해할 수 있습니다.

### 1\. 핵심 실행 및 설정 파일

봇의 시작점과 전반적인 행동을 결정하는 파일들입니다.

  * `main.py`
      * **역할:** 🤖 **봇의 심장.** 이 파일을 실행하면 봇이 시작됩니다.
      * **상세 설명:** 봇의 생명주기를 관리합니다. 봇이 시작될 때 디스코드에 로그인하고, 데이터베이스에 연결하며, `cogs` 폴더에 있는 모든 기능 모듈들을 불러와 봇에 장착시키는 역할을 합니다. 봇이 종료될 때는 모든 연결을 안전하게 끊습니다.
  * `config.py`
      * **역할:** 🧠 **봇의 두뇌 설정.** 봇의 모든 행동 방식과 페르소나, 규칙 등을 정의하는 중앙 설정 파일입니다.
      * **상세 설명:** AI 모델 이름, 날씨 API 좌표, 채널별 AI 페르소나, 각종 명령어에 대한 응답 메시지 등 봇의 거의 모든 것을 이곳에서 제어합니다. 코드를 직접 수정하지 않고도 봇의 성격이나 기능을 변경할 수 있습니다.
  * `logger_config.py`
      * **역할:** 📝 **봇의 모든 행동 기록관.** 봇이 수행하는 모든 작업과 발생하는 오류를 기록하는 방식을 설정합니다.
      * **상세 설명:** "봇이 방금 어떤 명령어를 처리했나?", "왜 오류가 발생했지?" 와 같은 질문에 답할 수 있도록, 모든 활동을 터미널과 로그 파일(`discord_logs.txt`, `error_logs.txt`)에 체계적으로 남기는 역할을 담당합니다.
  * `.env`
      * **역할:** 🔒 **비밀 금고.** 디스코드 봇 토큰, Gemini API 키 등 외부에 노출되면 안 되는 민감한 정보를 안전하게 보관합니다.

### 2\. 기능 모듈 (Cogs)

`discord.py`의 Cog 시스템을 활용하여, 봇의 각 기능을 레고 블록처럼 독립적으로 만들었습니다. 모든 파일은 `cogs/` 폴더 안에 있습니다.

  * `events.py`
      * **역할:** 👂 **봇의 귀.** 디스코드 서버에서 일어나는 모든 이벤트(메시지 수신, 삭제 등)를 가장 먼저 감지하는 역할을 합니다.
      * **상세 설명:** 사용자가 메시지를 보내면, `on_message` 이벤트가 가장 먼저 이를 포착합니다. 그리고 이 메시지가 일반 명령어인지, AI에게 보낸 메시지인지, 아니면 그냥 일반 대화인지를 판단하여 각각의 전문가(다른 Cog)에게 전달하는 **교통정리** 역할을 수행합니다.
  * `ai_handler.py`
      * **역할:** 💡 **AI 두뇌의 핵심.** Gemini AI와의 모든 통신을 전담하는 전문가입니다.
      * **상세 설명:** `events.py`로부터 메시지를 전달받으면, 사용자의 의도를 분석하고, 대화 기록을 참조하여 AI에게 질문을 던집니다. 그리고 AI로부터 받은 답변을 다시 `events.py`로 돌려주는, 봇의 모든 지능적인 상호작용을 책임지는 가장 중요한 모듈입니다.
  * `activity_cog.py`
      * **역할:** 📊 **커뮤니티 활동 분석가.** 서버 멤버들의 활동을 기록하고 `!랭킹` 명령어를 처리합니다.
      * **상세 설명:** 어떤 사용자가 얼마나 많은 메시지를 작성했는지 추적하여 데이터베이스에 기록합니다. `!랭킹` 명령어가 들어오면, 이 데이터를 바탕으로 '수다왕' 순위를 생성하여 보여줍니다.
  * `weather_cog.py`
      * **역할:** 🌦️ **기상 캐스터.** 날씨 관련 명령어와 주기적인 날씨 알림을 담당합니다.
      * **상세 설명:** `!날씨` 명령어를 처리하거나, AI가 날씨 질문을 감지했을 때 `utils.py`를 통해 기상청에 날씨 정보를 물어보고, 그 결과를 사용자에게 알려줍니다. 또한, 정해진 시간에 아침/저녁 인사나 비 예보를 알려주는 배경 작업도 수행합니다.
  * `fun_cog.py`
      * **역할:** 🎉 **재미 담당.** `!운세`, `!요약` 등 재미와 편의를 위한 기능을 제공합니다.
      * **상세 설명:** 사용자가 운세를 보거나 대화 요약을 요청하면, `ai_handler.py`와 협력하여 AI가 재치있는 답변을 생성하도록 돕습니다.
  * `poll_cog.py`
      * **역할:** 🗳️ **투표 진행자.** `!투표` 명령어를 통해 간단한 투표를 생성하고 관리합니다.
  * `commands.py`
      * **역할:** 🛠️ **관리자 도구함.** `!로그삭제`와 같이 서버 관리자만 사용할 수 있는 특별한 명령어들을 모아놓았습니다.

### 3\. 데이터베이스

봇의 '기억'을 영구적으로 저장하는 공간입니다. 모든 파일은 `database/` 폴더 안에 있습니다.

  * `remasamong.db`
      * **역할:** 💾 **봇의 모든 기억이 담긴 데이터베이스 파일.**
      * **상세 설명:** 대화 기록, 사용자 활동, 서버 설정 등 봇의 모든 상태가 이 단일 파일 안에 저장됩니다. 봇을 재시작해도 이 파일만 있으면 모든 것을 기억할 수 있습니다.
  * `schema.sql`
      * **역할:** 🏗️ **데이터베이스 설계도.**
      * **상세 설명:** 데이터베이스에 어떤 종류의 정보를, 어떤 형태로 저장할지를 정의하는 SQL 코드입니다. `init_db.py`가 이 설계도를 보고 데이터베이스 파일을 만듭니다.
  * `init_db.py`
      * **역할:** 👷 **데이터베이스 건설 인부.**
      * **상세 설명:** `schema.sql` 설계도를 읽어서, 실제 `remasamong.db` 파일을 생성하는 역할을 하는 일회성 스크립트입니다.

### 4\. 유틸리티 및 의존성

  * `utils.py`
      * **역할:** 🔧 **만능 도구 상자.**
      * **상세 설명:** 여러 Cog에서 공통적으로 사용되는 유용한 함수들을 모아놓은 곳입니다. 예를 들어, 기상청 API에 접속하여 데이터를 가져오는 복잡한 작업은 이 파일에 한 번만 작성해두고, `weather_cog`가 필요할 때마다 가져다 씁니다.
  * `requirements.txt`
      * **역할:** 📜 **쇼핑 리스트.**
      * **상세 설명:** 이 봇을 실행하는 데 필요한 모든 외부 라이브러리(`discord.py`, `google-generativeai` 등)의 목록과 버전이 적혀있습니다. `pip install -r requirements.txt` 명령어를 통해 이 목록에 있는 모든 것을 한 번에 설치할 수 있습니다.

## ⚙️ 설치 및 설정

### 1\. 사전 요구 사항

  * Python 3.11 이상
  * Discord 봇 토큰
  * Google Gemini API 키
  * 기상청 공공데이터포털 API 키

### 2\. 설치 과정

```bash
# 1. 저장소 복제
git clone <저장소_URL>
cd <프로젝트_디렉토리>

# 2. 파이썬 가상환경 생성 및 활성화
# (Windows에서는 python -m venv venv 및 .\venv\Scripts\activate)
python3 -m venv venv
source venv/bin/activate

# 3. 필수 라이브러리 설치
# (Windows에서는 requirements_windows.txt 사용)
pip install -r requirements.txt

# 4. 환경 변수 설정
# .env 파일을 생성하고 아래 내용을 채워주세요.
# DISCORD_BOT_TOKEN="YOUR_DISCORD_BOT_TOKEN"
# GEMINI_API_KEY="YOUR_GEMINI_API_KEY"
# KMA_API_KEY="YOUR_KMA_API_KEY"

# 5. 데이터베이스 초기화 (최초 1회만 실행)
python database/init_db.py

# 6. 봇 실행
python main.py
```

### 3\. Windows 환경에서의 테스트

Windows에서 테스트할 경우, `mecab-ko` 라이브러리 설치를 위해 몇 가지 추가 단계가 필요합니다.

1.  **Microsoft C++ Build Tools** 설치 ([다운로드 링크](https://www.google.com/search?q=https://visualstudio.microsoft.com/ko/visualstudio-web-installer/current/launch.exe))
2.  **SWIG for Windows** 설치 및 환경 변수(PATH) 설정 ([다운로드 링크](https://www.swig.org/download.html))
3.  `requirements_windows.txt` 파일을 사용하여 라이브러리를 설치합니다. (`pip install -r requirements_windows.txt`)

## 🔒 API 사용 및 안전장치

봇은 API 제한을 초과하지 않도록 여러 안전장치를 갖추고 있습니다.

  * **중앙 API 관리:** 모든 AI 호출은 `ai_handler`를 통해 이루어지며, 설정된 분당/하루 요청 횟수를 넘지 않도록 제어됩니다.
  * **쿨다운 시스템:** 자발적 응답 및 키워드 기반 기능은 모두 쿨다운 시스템이 적용되어, 단시간에 반복적으로 실행되어 API를 낭비하는 것을 방지합니다.

# 마사몽 AI 챗봇 2.0: 지능형 대화 플랫폼

마사몽은 단순한 명령어 봇을 넘어, 서버의 모든 대화를 기억하고, 문맥을 깊이 있게 이해하며, 사용자의 자연어 명령을 지능적으로 수행하는 AI 대화 플랫폼입니다. '마사몽'이라는 독특한 페르소나를 바탕으로 서버 멤버들과 진정한 유대감을 형성하고, 커뮤니티에 활기를 불어넣는 것을 목표로 합니다.

## 🤖 봇의 핵심 아키텍처

마사몽 2.0은 저사양 서버 환경에서도 최상의 성능을 발휘할 수 있도록 설계된, 다음과 같은 최신 AI 아키텍처를 기반으로 동작합니다.

### 영속적 대화 기억 (RAG) 작동 방식

봇은 더 이상 대화 내용을 잊어버리지 않습니다. 마사몽의 핵심 기억 메커니즘은 다음과 같은 **검색 증강 생성(RAG)** 파이프라인을 통해 이루어집니다.

1.  **대화 저장 (Logging)**: 사용자가 허용된 채널에서 메시지를 보내면, 해당 메시지는 즉시 `SQLite` 데이터베이스의 `conversation_history` 테이블에 기록됩니다.

2.  **의미 추출 (Embedding)**: 메시지가 저장된 직후, 봇은 백그라운드에서 Google의 `embedding-001` API를 호출합니다. 이 API는 메시지 텍스트를 "의미"를 나타내는 숫자의 배열(벡터)로 변환합니다. 이 벡터는 단순한 키워드 매칭을 넘어, 문장의 문맥과 뉘앙스를 포착합니다. 변환된 벡터는 데이터베이스의 해당 메시지 옆에 함께 저장됩니다.

3.  **질문 분석 (Querying)**: 사용자가 `@마사몽`을 언급하며 질문을 하면, 봇은 먼저 이 새로운 질문 또한 `embedding-001` API를 통해 벡터로 변환합니다.

4.  **관련 기억 검색 (Retrieval)**: 봇은 방금 생성된 질문 벡터를 가지고 데이터베이스에 저장된 과거 대화 벡터들과 비교합니다. **코사인 유사도(Cosine Similarity)** 계산을 통해, 질문과 의미적으로 가장 유사하거나 관련된 과거 대화들을 상위 5개까지 찾아냅니다.
    -   **기억의 범위**: 이 검색 과정은 `AGENTS.md`의 설계에 따라, **"현재 채널에서, 현재 질문한 사용자가 했던 말"**로 범위가 엄격하게 제한됩니다. 이를 통해 다른 사람의 대화나 다른 채널의 대화를 잘못 참조하는 것을 방지합니다.

5.  **문맥 기반 답변 생성 (Generation)**: 마지막으로, 봇은 검색된 상위 5개의 관련성 높은 과거 대화 내용을 참고자료로 삼아, 사용자의 현재 질문과 함께 Gemini AI에게 전달합니다. AI는 이 풍부한 문맥을 바탕으로 훨씬 더 깊이 있고, 대화의 흐름에 맞는 답변을 생성하게 됩니다.

### 동적 서버별 설정

모든 서버는 이제 디스코드의 **Slash Command (/)**를 통해 자신만의 설정을 가질 수 있습니다. 관리자는 더 이상 `config.py` 파일을 직접 수정할 필요 없이, 간단한 명령어로 AI의 작동 방식을 서버에 맞게 커스터마이징할 수 있습니다.

### 안정적인 데이터 관리

모든 사용자 활동, 대화 기록, 서버 설정, API 사용량 등은 `SQLite` 데이터베이스에 안전하게 저장되어, 봇을 재시작해도 데이터가 유실되지 않습니다.

## ✨ 주요 기능 및 사용법

### 1. 일반 사용자 기능

- **AI 채팅 (자연어 상호작용)**
  `@마사몽`으로 봇을 직접 호출하여 질문하거나, 대화 중에 `마사몽`, `봇` 등의 키워드를 언급하여 봇의 참여를 유도할 수 있습니다.
  - `@마사몽 어제 우리가 얘기했던 LLM 최적화 방안 다시 설명해줄래?`
  - `@마사몽 내일 부산 날씨 어때?`
  - `@마사몽 오늘 내 운세 좀 봐줘`

- **명령어**
  - `!랭킹` 또는 `!수다왕`: 서버 내 메시지 작성 빈도를 기준으로 '수다왕' 랭킹을 보여줍니다.
  - `!투표 "질문" "항목1" "항목2"`: 간단한 주제에 대해 투표를 생성합니다.

### 2. 서버 관리자 기능 (Slash Commands)

서버 관리자는 슬래시(`/`) 명령어를 통해 봇의 작동 방식을 서버별로 제어할 수 있습니다.

- **/config set_ai `enabled:[True/False]`**
  - 서버 전체의 AI 기능 활성화 여부를 설정합니다. `False`로 설정 시, 해당 서버에서는 AI가 전혀 응답하지 않습니다.

- **/config channel `action:[추가/제거]` `channel:[채널]`**
  - AI가 응답할 수 있는 채널을 관리합니다. 이 설정을 통해 특정 채널에서만 AI가 활동하도록 제한할 수 있습니다.

- **/persona set**
  - 현재 서버의 AI 페르소나를 직접 수정합니다. 명령어를 실행하면 페르소나를 입력할 수 있는 팝업창이 나타납니다.

- **/persona view**
  - 현재 서버에 설정된 커스텀 페르소나를 확인합니다. 설정된 페르소나가 없으면 기본 페르소나를 사용합니다.

## ⚙️ 설치 및 설정

### 1. 사전 요구 사항

- Python 3.11 이상
- Discord 봇 토큰
- Google Gemini API 키
- 기상청 공공데이터포털 API 키

### 2. 설치 과정

```bash
# 1. 저장소 복제
git clone <저장소_URL>
cd <프로젝트_디렉토리>

# 2. 파이썬 가상환경 생성 및 활성화
# (Windows에서는 python -m venv venv 및 .\\venv\\Scripts\\activate)
python3 -m venv venv
source venv/bin/activate

# 3. 필수 라이브러리 설치
pip install -r requirements.txt

# 4. 환경 변수 설정
# .env 파일을 생성하고 아래 내용을 채워주세요.
# DISCORD_BOT_TOKEN="YOUR_DISCORD_BOT_TOKEN"
# GEMINI_API_KEY="YOUR_GEMINI_API_KEY"
# KMA_API_KEY="YOUR_KMA_API_KEY"

# 5. 데이터베이스 초기화 (최초 1회만 실행)
python3 database/init_db.py

# 6. 봇 실행
python3 main.py
```

## 🔧 안정성 및 확장성

- **안정적인 백그라운드 작업**: 모든 주기적인 작업(날씨 알림 등)에는 에러 핸들러가 구현되어, 특정 작업에서 오류가 발생하더라도 전체 봇이 중단되는 것을 방지합니다.
- **분석 기반 마련**: 모든 명령어 사용 및 AI 상호작용(토큰 사용량 포함)은 `analytics_log` 테이블에 기록됩니다. 이 데이터는 향후 Grafana 등의 시각화 도구와 연동하여 봇의 운영 상태를 모니터링하는 대시보드를 구축하는 데 사용될 수 있습니다.
